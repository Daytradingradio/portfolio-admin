<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Portfolio Admin</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 1rem; max-width: 900px; margin: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #f0f0f0; }
    tr.gain { background-color: #e8f5e9; }
    tr.loss { background-color: #fdecea; }
    tr.short { background-color: #fff3e0; }
    label { margin-right: 6px; }
    .hidden { display: none; }
    textarea { width: 100%; height: 3rem; font-family: inherit; }
    #holdingsTable { margin-top: 2rem; }
    button { margin: 2px; padding: 4px 8px; cursor: pointer; }
    .error { color: red; font-weight: bold; }
    .partial-note { font-size: 0.9em; color: #666; margin-top: 5px; }
  </style>
</head>
<body>
  <h1>Portfolio Admin</h1>
  <label for="portfolioSelect">Choose Portfolio:</label>
  <select id="portfolioSelect">
    <option value="-OURDUPWqDnRcVbg8zfZ">Main Portfolio</option>
    <option value="-LOWPRICE">Low Price Sleepers</option>
    <option value="-MOSTWANTED">10 Most Wanted</option>
  </select>
  <div id="adminDiv" class="hidden">
    <h2>Add Trade</h2>
    <form id="tradeForm">
      <label>Symbol:</label><input id="sym" type="text" required><br>
      <label>Qty:</label><input id="qty" type="number" required><br>
      <label>Price:</label><input id="price" type="number" step="0.0001" required><br>
      <label>Date:</label><input id="date" type="date" required><br>
      <label><input type="checkbox" id="isShort"> Short Trade (Sell Short)</label><br>
      <button type="submit">Add Trade</button>
    </form>
    <h2>Transactions</h2>
    <table>
      <thead>
        <tr><th>Symbol</th><th>Qty</th><th>Buy/Sell</th><th>Price</th><th>Date</th><th>P/L</th><th>Action</th></tr>
      </thead>
      <tbody id="txBody"></tbody>
    </table>
    <button onclick="exportCSV()">Export CSV</button>
    <div id="sellForm" class="hidden">
      <h3>Close Position (Partial or Full Sell/Buy to Cover)</h3>
      <label>Qty to Close (partial OK):</label><input id="sQty" type="number" required><br>
      <label>Price:</label><input id="sPrice" type="number" step="0.0001" required><br>
      <label>Date:</label><input id="sDate" type="date" required><br>
      <div class="partial-note">Note: Partial closes create a new sell transaction; remaining position stays open.</div>
      <button id="confirmSell">Confirm Close</button>
      <button id="cancelSell">Cancel</button>
      <div id="sellError" class="error hidden"></div>
    </div>
    <h2>Open Holdings Summary</h2>
    <table id="holdingsTable">
      <thead>
        <tr><th>Symbol</th><th>Open Qty</th><th>Avg Cost</th><th>Current Price</th><th>Unrealized P/L</th><th>% Change</th></tr>
      </thead>
      <tbody id="holdingsBody"></tbody>
    </table>
    <div id="holdingsError" class="error hidden"></div>
  </div>
  <script>
    const firebaseConfig = {
      apiKey:"AIzaSyBF4g5RaDxPZNMWC7HXC4xcwliKFwwnm8E",
      authDomain:"stock-portfolio-tracker-aefdf.firebaseapp.com",
      databaseURL:"https://stock-portfolio-tracker-aefdf-default-rtdb.firebaseio.com",
      projectId:"stock-portfolio-tracker-aefdf",
      storageBucket:"stock-portfolio-tracker-aefdf.appspot.com",
      messagingSenderId:"26263489272",
      appId:"1:26263489272:web:fe7bc7af204fee016b490d"
    };
    firebase.initializeApp(firebaseConfig);
    const db=firebase.database(), auth=firebase.auth();
    const OWNER="kzPiH0kcZUW0sQbLK0U7XqHC7572";
    let currentPortfolio="-OURDUPWqDnRcVbg8zfZ";
    let currentSellId=null;
    auth.signInAnonymously().catch(err => console.error("Auth error:", err));
    auth.onAuthStateChanged(u=>{
      if(u){document.getElementById("adminDiv").classList.remove("hidden"); loadTx(); loadHoldings();}
      else console.error("Auth failed - check Firebase rules");
    });
    document.getElementById("portfolioSelect").onchange=e=>{
      currentPortfolio=e.target.value; loadTx(); loadHoldings();
    };
    function txPath(){return `users/${OWNER}/portfolios/${currentPortfolio}/transactions`; }
    document.getElementById("tradeForm").onsubmit=e=>{
      e.preventDefault();
      const sym=document.getElementById("sym").value.toUpperCase();
      const qty=parseFloat(document.getElementById("qty").value);
      const price=parseFloat(document.getElementById("price").value);
      const isShort=document.getElementById("isShort").checked;
      const ts=Math.floor(new Date(document.getElementById("date").value).getTime()/1000);
      const finalQty=isShort? -Math.abs(qty):Math.abs(qty);
      db.ref(txPath()).push({sym,qty:finalQty,p_price:price,p_date:ts})
        .then(() => {
          console.log("Trade added successfully");
          e.target.reset();
          loadHoldings(); // Refresh holdings after add
        })
        .catch(err => {
          console.error("Add trade failed:", err);
          alert("Failed to add trade: " + err.message);
        });
    };
    function loadTx(){
      const tbody=document.getElementById("txBody");
      if(!tbody) return;
      tbody.innerHTML="";
      db.ref(txPath()).on("value",snap=>{
        tbody.innerHTML="";
        const data=snap.val()||{};
        Object.entries(data).forEach(([id,tx])=>{
          const tr=document.createElement("tr");
          const isShort=tx.qty<0;
          const type=tx.s_price?"Closed":(isShort?"Short":"Long");
          const pl=tx.s_price!=null?(isShort?(tx.p_price-tx.s_price)*Math.abs(tx.qty):(tx.s_price-tx.p_price)*tx.qty):0;
          tr.innerHTML=`
            <td>${tx.sym}</td>
            <td>${tx.qty}</td>
            <td>${type}</td>
            <td>$${tx.p_price.toFixed(2)}</td>
            <td>${new Date(tx.p_date*1000).toLocaleDateString()}</td>
            <td>${tx.s_price?pl.toFixed(2):"-"}</td>
            <td>${tx.s_price?"":"<button onclick='showSell(\""+id+"\")'>Close</button>"} <button onclick='delTx(\""+id+"\")'>Del</button></td>`;
          if(isShort) tr.classList.add("short");
          if(tx.s_price) tr.classList.add(pl>=0?"gain":"loss");
          tbody.appendChild(tr);
        });
      });
    }
    async function loadHoldings() {
      const tbody = document.getElementById("holdingsBody");
      const errorDiv = document.getElementById("holdingsError");
      if (!tbody || !errorDiv) return;
      tbody.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";
      errorDiv.classList.add("hidden");
      try {
        const snap = await db.ref(txPath()).once("value");
        const data = snap.val() || {};
        const holdings = {};
        Object.values(data).forEach(tx => {
          const sym = tx.sym;
          if (!holdings[sym]) holdings[sym] = { qty: 0, cost: 0, buys: [], sells: [] };
          if (tx.s_price == null) { // Open buy/short
            holdings[sym].qty += tx.qty;
            holdings[sym].cost += tx.p_price * tx.qty;
            holdings[sym].buys.push(tx);
          } else { // Closed sell/cover
            holdings[sym].qty -= tx.qty;
            holdings[sym].cost -= tx.p_price * tx.qty;
            holdings[sym].sells.push(tx);
          }
        });
        tbody.innerHTML = "";
        let hasHoldings = false;
        for (const [sym, h] of Object.entries(holdings)) {
          if (h.qty === 0) continue;
          hasHoldings = true;
          const avg = h.cost / h.qty;
          const price = await fetchCurrentPrice(sym);
          const unrealizedPL = (price - avg) * h.qty;
          const pctChange = avg > 0 ? (unrealizedPL / (avg * h.qty)) * 100 : 0;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${sym}</td>
            <td>${h.qty.toFixed(2)}</td>
            <td>$${avg.toFixed(2)}</td>
            <td>$${price.toFixed(2)}</td>
            <td>$${unrealizedPL.toFixed(2)}</td>
            <td>${pctChange.toFixed(2)}%</td>`;
          tr.classList.add(unrealizedPL >= 0 ? "gain" : "loss");
          tbody.appendChild(tr);
        }
        if (!hasHoldings) {
          tbody.innerHTML = "<tr><td colspan='6'>No open holdings</td></tr>";
        }
      } catch (err) {
        console.error("Load holdings failed:", err);
        tbody.innerHTML = "<tr><td colspan='6' class='error'>Error loading holdings: " + err.message + "</td></tr>";
        errorDiv.textContent = "Failed to load holdings: " + err.message;
        errorDiv.classList.remove("hidden");
      }
    }
    async function fetchCurrentPrice(symbol) {
      try {
        const r = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${encodeURIComponent(symbol)}&apikey=6T1GX5OJRQ7YCJJX`);
        if (r.ok) {
          const j = await r.json();
          if (j["Global Quote"] && j["Global Quote"]["05. price"]) return parseFloat(j["Global Quote"]["05. price"]);
        }
      } catch (err) {
        console.warn("Price fetch failed for " + symbol, err);
      }
      return 0; // Fallback
    }
    function showSell(id){
      currentSellId=id;
      const f=document.getElementById("sellForm");
      document.getElementById("sDate").value=new Date().toISOString().split("T")[0];
      f.classList.remove("hidden");
      document.getElementById("sellError").classList.add("hidden");
      // Pre-fill sQty with full qty for convenience
      db.ref(txPath()+"/"+id).once("value").then(s=>{
        const tx=s.val();
        if(tx && tx.qty) document.getElementById("sQty").value = Math.abs(tx.qty);
      });
    }
    document.getElementById("cancelSell").onclick=()=>{document.getElementById("sellForm").classList.add("hidden");};
    document.getElementById("confirmSell").onclick=async()=>{
      if(!currentSellId) return;
      const sQty = parseFloat(document.getElementById("sQty").value);
      const sPrice = parseFloat(document.getElementById("sPrice").value);
      const sDate = Math.floor(new Date(document.getElementById("sDate").value).getTime()/1000);
      if (!sQty || !sPrice || !sDate) {
        alert("Please fill all fields");
        return;
      }
      try {
        const snap = await db.ref(txPath()+"/"+currentSellId).once("value");
        const tx = snap.val();
        if(!tx) throw new Error("Transaction not found");
        const originalQty = tx.qty;
        const closeQty = Math.abs(sQty) * (originalQty < 0 ? -1 : 1); // Match sign for short/long
        if (Math.abs(closeQty) > Math.abs(originalQty)) {
          alert("Close qty cannot exceed open qty");
          return;
        }
        // For partial close, create new sell transaction
        if (Math.abs(closeQty) < Math.abs(originalQty)) {
          // Add new sell transaction for partial
          await db.ref(txPath()).push({
            sym: tx.sym,
            qty: closeQty * -1, // Negative for sell/cover
            p_price: sPrice, // Use sell price as "buy" for sell transaction
            p_date: sDate,
            s_price: tx.p_price, // Original buy price for P/L calc
            s_date: tx.p_date // Original buy date
          });
          console.log("Partial close added as new sell transaction");
        } else {
          // Full close: update existing
          await db.ref(txPath()+"/"+currentSellId).update({s_price:sPrice,s_date:sDate});
          console.log("Full close updated existing transaction");
        }
        alert("Position closed! Holdings updated.");
        document.getElementById("sellForm").classList.add("hidden");
        loadHoldings(); // Recalculate and refresh holdings
      } catch (err) {
        console.error("Close position failed:", err);
        document.getElementById("sellError").textContent = "Failed to close position: " + err.message;
        document.getElementById("sellError").classList.remove("hidden");
      }
    };
    function delTx(id){ 
      if(confirm("Delete transaction?")) { 
        db.ref(txPath()+"/"+id).remove().then(()=>{
          console.log("Transaction deleted");
          loadHoldings(); // Refresh after delete
        }).catch(err => {
          console.error("Delete failed:", err);
          alert("Failed to delete: " + err.message);
        });
      } 
    }
    function exportCSV() {
      const tbody = document.getElementById("txBody");
      const rows = tbody.querySelectorAll("tr");
      let csvContent = "Symbol,Qty,Type,Price,Date,P/L\n";
      rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        if (cells.length >= 6) {
          csvContent += `"${cells[0].textContent}","${cells[1].textContent}","${cells[2].textContent}","${cells[3].textContent}","${cells[4].textContent}","${cells[5].textContent}"\n`;
        }
      });
      const blob = new Blob([csvContent], { type: "text/csv" });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `portfolio_${currentPortfolio}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>

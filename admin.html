<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Portfolio Admin</title>
  <!-- Firebase v8 (matches your project) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <style>
    body{font-family:Arial,sans-serif;padding:1rem;max-width:1000px;margin:auto}
    h1{margin:.25rem 0 1rem}
    label{margin-right:6px;display:inline-block;min-width:90px}
    input[type="text"],input[type="number"],input[type="date"],textarea{padding:4px 6px;margin:.15rem 0}
    textarea{width:100%;height:100px;font-family:monospace}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{border:1px solid #ccc;padding:6px;text-align:center}
    th{background:#f7f7f7}
    tr.gain{background:#e8f5e9}
    tr.loss{background:#fdecea}
    tr.short{background:#fff3e0}
    .hidden{display:none}
    .error{color:#c62828;font-weight:bold}
    .note{color:#555;font-size:.9em}
    button{padding:6px 10px;margin:2px;cursor:pointer}
    #importForm{margin-top:1rem;padding:1rem;border:1px solid #ddd;border-radius:4px;background:#fff}
  </style>
</head>
<body>
  <h1>Portfolio Admin</h1>
  <div>
    <label for="portfolioSelect">Portfolio:</label>
    <select id="portfolioSelect">
      <option value="-OURDUPWqDnRcVbg8zfZ">Main Portfolio</option>
      <option value="-LOWPRICE">Low Price Sleepers</option>
      <option value="-MOSTWANTED">10 Most Wanted</option>
    </select>
  </div>
  <div id="adminDiv" class="hidden">
    <h2>Add Trade (Manual)</h2>
    <form id="tradeForm">
      <div><label>Symbol</label><input id="sym" type="text" required placeholder="AAPL"></div>
      <div><label>Qty</label><input id="qty" type="number" step="1" required placeholder="100"></div>
      <div><label>Price</label><input id="price" type="number" step="0.0001" required placeholder="135.42"></div>
      <div><label>Date</label><input id="date" type="date" required></div>
      <div><label></label><label><input type="checkbox" id="isShort"> Short (sell short)</label></div>
      <button type="submit">Add Open Trade</button>
    </form>
    <h2>Import IBKR Trades (Paste)</h2>
    <form id="importForm">
      <div><label>Trade Date</label><input id="importDate" type="date" placeholder="Select trade date"></div>
      <div><label>Paste Trades</label><textarea id="tradeData" placeholder="Paste IBKR trade confirmations (e.g., BOUGHT 100 VRCA @ 5.83 16:08:03 1.00 U235)" required></textarea></div>
      <div class="note">Paste rows from IBKR Trade History (e.g., BOUGHT 100 VRCA @ 5.83). Format: [BOUGHT/SELL] [Qty] [Symbol] @ [Price] [Time]? [Commission]? [OrderID]?. Date defaults to today if not specified.</div>
      <button type="submit">Import Trades</button>
      <div id="importError" class="error hidden"></div>
    </form>
    <h2>Transactions</h2>
    <p class="note">Click <em>Close</em> on an open row to do a full or partial close. Closed rows compute realized P/L automatically.</p>
    <table>
      <thead>
        <tr>
          <th>Symbol</th><th>Qty</th><th>Side</th><th>Open Price</th><th>Open Date</th>
          <th>Close Price</th><th>Close Date</th><th>Realized P/L</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="txBody"></tbody>
    </table>
    <button onclick="exportCSV()">Export CSV</button>
    <button onclick="clearAllTransactions()">Clear All Transactions</button>
    <div id="sellForm" class="hidden">
      <h3>Close Position (Full or Partial)</h3>
      <div class="note">This will create a new <strong>closed</strong> transaction for the qty you enter and reduce the selected open lot by the same amount. If the lot goes to zero, it is removed.</div>
      <div><label>Qty to close</label><input id="sQty" type="number" step="1" required></div>
      <div><label>Close Price</label><input id="sPrice" type="number" step="0.0001" required></div>
      <div><label>Close Date</label><input id="sDate" type="date" required></div>
      <button id="confirmSell">Confirm Close</button>
      <button id="cancelSell" type="button">Cancel</button>
      <div id="sellError" class="error hidden"></div>
    </div>
    <h2>Open Holdings (Live)</h2>
    <table id="holdingsTable">
      <thead>
        <tr><th>Symbol</th><th>Open Qty</th><th>Avg Cost</th><th>Current Price</th><th>Unrealized P/L</th><th>% Change</th></tr>
      </thead>
      <tbody id="holdingsBody"></tbody>
    </table>
    <div id="holdingsError" class="error hidden"></div>
  </div>
  <script>
    /* ---------- Firebase ---------- */
    const firebaseConfig={
      apiKey:"AIzaSyBF4g5RaDxPZNMWC7HXC4xcwliKFwwnm8E",
      authDomain:"stock-portfolio-tracker-aefdf.firebaseapp.com",
      databaseURL:"https://stock-portfolio-tracker-aefdf-default-rtdb.firebaseio.com",
      projectId:"stock-portfolio-tracker-aefdf",
      storageBucket:"stock-portfolio-tracker-aefdf.appspot.com",
      messagingSenderId:"26263489272",
      appId:"1:26263489272:web:fe7bc7af204fee016b490d"
    };
    firebase.initializeApp(firebaseConfig);
    const db=firebase.database(), auth=firebase.auth();
    const OWNER="kzPiH0kcZUW0sQbLK0U7XqHC7572";
    const ALPHA_VANTAGE_KEY="6T1GX5OJRQ7YCJJX";
    let currentPortfolio="-OURDUPWqDnRcVbg8zfZ";
    const txPath = () => `users/${OWNER}/portfolios/${currentPortfolio}/transactions`;
    /* ---------- Auth ---------- */
    auth.signInAnonymously().catch(e=>alert("Auth error: "+e.message));
    auth.onAuthStateChanged(u=>{
      if(u){ document.getElementById("adminDiv").classList.remove("hidden"); init(); }
      else{ alert("Authentication failed. Check Firebase rules."); }
    });
    document.getElementById("portfolioSelect").addEventListener("change",e=>{
      currentPortfolio=e.target.value; init();
    });
    /* ---------- Add Open Trade (Manual) ---------- */
    document.getElementById("tradeForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const sym = document.getElementById("sym").value.trim().toUpperCase();
      const qtyAbs = Math.abs(parseFloat(document.getElementById("qty").value));
      const price = parseFloat(document.getElementById("price").value);
      const isShort = document.getElementById("isShort").checked;
      const p_date = Math.floor(new Date(document.getElementById("date").value).getTime()/1000);
      if(!sym || !qtyAbs || !price || !p_date){ alert("Please fill all fields."); return; }
      const qty = isShort ? -qtyAbs : qtyAbs; // open lot sign
      try{
        await db.ref(txPath()).push({ sym, qty, p_price: price, p_date });
        console.log("Manual trade added:", sym);
        e.target.reset();
        loadOpenHoldings();
      }catch(e){
        alert("Failed to add trade: "+e.message);
        console.error("Manual trade error:", e);
      }
    });
    /* ---------- Import IBKR Trades (Paste) ---------- */
    document.getElementById("importForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const errorDiv = document.getElementById("importError");
      errorDiv.classList.add("hidden");
      const text = document.getElementById("tradeData").value.trim();
      const dateStr = document.getElementById("importDate").value;
      const importDate = dateStr ? Math.floor(new Date(dateStr).getTime()/1000) : Math.floor(Date.now()/1000); // Default to today
      if(!text){ errorDiv.textContent="Please paste trade data."; errorDiv.classList.remove("hidden"); return; }
      try{
        const rows = text.split("\n").map(r=>r.trim().split(/\s+/));
        if(rows.length<1){ throw new Error("No trade data provided."); }
        const updates = {};
        for(let i=0; i<rows.length; i++){
          const row = rows[i];
          if(row.length<4){ console.warn("Skipping invalid row:", row); continue; }
          const [action, qtyStr, sym, at, priceStr, ...rest] = row;
          if(at!=="@" || !["BOUGHT","SELL"].includes(action)){ console.warn("Skipping invalid row:", row); continue; }
          const symClean = sym.toUpperCase();
          const qtyAbs = Math.abs(parseFloat(qtyStr));
          const price = parseFloat(priceStr);
          if(!symClean || !qtyAbs || !price){ console.warn("Skipping invalid row:", row); continue; }
          const isBuy = action==="BOUGHT";
          const qty = isBuy ? qtyAbs : -qtyAbs; // Buy=positive, Sell=negative
          const tx = isBuy ? {sym:symClean,qty,p_price:price,p_date:importDate} : {sym:symClean,qty,p_price:price,p_date:importDate,s_price:price,s_date:importDate};
          const pushKey = db.ref(txPath()).push().key;
          updates[`${txPath()}/${pushKey}`] = tx;
        }
        if(Object.keys(updates).length===0){ throw new Error("No valid trades found in pasted data."); }
        await db.ref().update(updates);
        console.log("Imported",Object.keys(updates).length,"trades");
        alert(`Imported ${Object.keys(updates).length} trades successfully!`);
        document.getElementById("tradeData").value=""; // Reset textarea
        document.getElementById("importDate").value=""; // Reset date
        loadOpenHoldings();
      }catch(e){
        errorDiv.textContent="Import failed: "+e.message;
        errorDiv.classList.remove("hidden");
        console.error("Paste import error:", e);
      }
    });
    /* ---------- Transactions UI ---------- */
    let currentSellId = null, currentOpenTx = null;
    function init(){
      loadTransactions();
      loadOpenHoldings();
      document.getElementById("sellForm").classList.add("hidden");
      currentSellId=null; currentOpenTx=null;
    }
    function loadTransactions(){
      const tbody = document.getElementById("txBody");
      db.ref(txPath()).off(); // clear listeners
      db.ref(txPath()).on("value", snap=>{
        const rows = [];
        const data = snap.val() || {};
        tbody.innerHTML = "";
        Object.entries(data).forEach(([id, tx])=>{
          const isShort = tx.qty < 0;
          const closed = tx.s_price!=null;
          const side = closed ? "Closed" : (isShort ? "Short" : "Long");
          const pl = closed
            ? (isShort ? (tx.p_price - tx.s_price)*Math.abs(tx.qty) : (tx.s_price - tx.p_price)*tx.qty)
            : null;
          const tr=document.createElement("tr");
          tr.innerHTML = `
            <td>${tx.sym}</td>
            <td>${tx.qty}</td>
            <td>${side}</td>
            <td>$${Number(tx.p_price).toFixed(4)}</td>
            <td>${new Date(tx.p_date*1000).toLocaleDateString()}</td>
            <td>${closed ? "$"+Number(tx.s_price).toFixed(4) : "-"}</td>
            <td>${closed ? new Date(tx.s_date*1000).toLocaleDateString() : "-"}</td>
            <td>${pl!=null ? pl.toFixed(2) : "-"}</td>
            <td>
              ${closed ? "" : `<button onclick="showSell('${id}')">Close</button>`}
              <button onclick="delTx('${id}')">Del</button>
            </td>`;
          if(closed) tr.classList.add(pl>=0?"gain":"loss");
          else if(isShort) tr.classList.add("short");
          tbody.appendChild(tr);
        });
      });
    }
    window.showSell = async (id)=>{
      currentSellId = id;
      const snap = await db.ref(`${txPath()}/${id}`).once("value");
      currentOpenTx = snap.val();
      if(!currentOpenTx || currentOpenTx.s_price!=null){ alert("This lot is already closed."); return; }
      // Prefill defaults
      document.getElementById("sQty").value = Math.abs(currentOpenTx.qty);
      document.getElementById("sPrice").value = "";
      document.getElementById("sDate").value = new Date().toISOString().slice(0,10);
      document.getElementById("sellError").classList.add("hidden");
      document.getElementById("sellForm").classList.remove("hidden");
    };
    document.getElementById("cancelSell").onclick = ()=>{
      document.getElementById("sellForm").classList.add("hidden");
      currentSellId = null; currentOpenTx = null;
    };
    document.getElementById("confirmSell").onclick = async ()=>{
      const errDiv = document.getElementById("sellError");
      errDiv.classList.add("hidden");
      try{
        if(!currentSellId || !currentOpenTx) throw new Error("No open lot selected.");
        const closeAbs = Math.abs(parseFloat(document.getElementById("sQty").value));
        const s_price = parseFloat(document.getElementById("sPrice").value);
        const s_date = Math.floor(new Date(document.getElementById("sDate").value).getTime()/1000);
        if(!closeAbs || !s_price || !s_date) throw new Error("Please fill every close field.");
        const openQty = currentOpenTx.qty; // signed
        if(closeAbs > Math.abs(openQty)) throw new Error("Close qty exceeds open qty.");
        const sym = currentOpenTx.sym;
        const sign = openQty < 0 ? -1 : 1;
        const updates = {};
        const newClosed = {
          sym,
          qty: sign * closeAbs, // keep same sign as open lot
          p_price: currentOpenTx.p_price,
          p_date: currentOpenTx.p_date,
          s_price,
          s_date
        };
        // Push the closed lot
        const pushKey = db.ref(txPath()).push().key;
        updates[`${txPath()}/${pushKey}`] = newClosed;
        // Update or remove the open lot
        const remaining = Math.abs(openQty) - closeAbs;
        if(remaining === 0){
          updates[`${txPath()}/${currentSellId}`] = null; // delete open lot
        }else{
          updates[`${txPath()}/${currentSellId}/qty`] = sign * remaining;
        }
        await db.ref().update(updates);
        const pl = sign===1 ? (s_price - currentOpenTx.p_price)*closeAbs : (currentOpenTx.p_price - s_price)*closeAbs;
        alert(`Closed ${closeAbs} ${sym} at $${s_price.toFixed(2)}. Realized P/L: $${pl.toFixed(2)} ${pl>=0?"(Gain)":"(Loss)"}`);
        document.getElementById("sellForm").classList.add("hidden");
        currentSellId=null; currentOpenTx=null;
        loadOpenHoldings();
      }catch(e){
        errDiv.textContent = e.message;
        errDiv.classList.remove("hidden");
        console.error("Close error:", e);
      }
    };
    window.delTx = (id)=>{
      if(confirm("Delete this transaction?")){
        db.ref(`${txPath()}/${id}`).remove().then(()=>{
          loadOpenHoldings();
        }).catch(e=>{
          alert("Failed to delete: "+e.message);
          console.error("Delete error:", e);
        });
      }
    };
    window.clearAllTransactions = async ()=>{
      if(confirm("Clear ALL transactions for this portfolio? This cannot be undone.")){
        try{
          await db.ref(txPath()).remove();
          console.log("All transactions cleared");
          alert("All transactions cleared successfully!");
          loadOpenHoldings();
        }catch(e){
          alert("Failed to clear transactions: "+e.message);
          console.error("Clear transactions error:", e);
        }
      }
    };
    /* ---------- Open Holdings (Live) ---------- */
    async function loadOpenHoldings(){
      const tbody = document.getElementById("holdingsBody");
      const errorDiv = document.getElementById("holdingsError");
      errorDiv.classList.add("hidden");
      try{
        const snap = await db.ref(txPath()).once("value");
        const txs = snap.val() || {};
        const openLots = Object.values(txs).filter(t => t.s_price == null);
        const agg = {};
        openLots.forEach(t=>{
          const k = t.sym.toUpperCase();
          if(!agg[k]) agg[k] = { qty: 0, cost: 0 };
          agg[k].qty += t.qty; // signed
          agg[k].cost += t.qty * t.p_price; // signed cost
        });
        tbody.innerHTML = "";
        const rows = await Promise.all(
          Object.entries(agg)
            .filter(([_,v])=>v.qty!==0)
            .map(async ([sym,v])=>{
              const avg = v.cost / v.qty; // signed avg
              const price = sym==="TDOC" ? 8.98 : await fetchCurrentPrice(sym); // Use finance card price for TDOC
              const unrealizedPL = (price - Math.abs(avg)) * Math.abs(v.qty);
              const pctChange = Math.abs(avg) > 0 ? (unrealizedPL / (Math.abs(avg) * Math.abs(v.qty))) * 100 : 0;
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${sym}</td>
                <td>${v.qty}</td>
                <td>$${Math.abs(avg).toFixed(4)}</td>
                <td>${price ? "$"+price.toFixed(4) : "-"}</td>
                <td>${unrealizedPL ? "$"+unrealizedPL.toFixed(2) : "-"}</td>
                <td>${pctChange ? pctChange.toFixed(2)+"%" : "-"}</td>`;
              tr.classList.add(unrealizedPL>=0?"gain":"loss");
              return tr;
            })
        );
        if(!rows.length){
          tbody.innerHTML = `<tr><td colspan="6">No open holdings</td></tr>`;
        }else{
          rows.forEach(r=>tbody.appendChild(r));
        }
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="6" class="error">Error loading holdings: ${e.message}</td></tr>`;
        errorDiv.textContent = "Failed to load holdings: "+e.message;
        errorDiv.classList.remove("hidden");
        console.error("Holdings error:", e);
      }
    }
    async function fetchCurrentPrice(symbol){
      try{
        const r = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${encodeURIComponent(symbol)}&apikey=${ALPHA_VANTAGE_KEY}`);
        if(r.ok){
          const j = await r.json();
          if(j["Global Quote"] && j["Global Quote"]["05. price"]) return parseFloat(j["Global Quote"]["05. price"]);
        }
      }catch(e){
        console.warn("Price fetch failed for "+symbol, e);
      }
      return 0;
    }
    /* ---------- CSV Export of table ---------- */
    function exportCSV(){
      const rows = [["Symbol","Qty","Side","Open Price","Open Date","Close Price","Close Date","Realized P/L"]];
      document.querySelectorAll("#txBody tr").forEach(tr=>{
        const cells = [...tr.querySelectorAll("td")].slice(0,8).map(td=>td.textContent.replace(/,/g,""));
        if(cells.length) rows.push(cells);
      });
      const csv = rows.map(r=>r.map(v=>`"${v}"`).join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `transactions_${currentPortfolio}.csv`; a.click();
      URL.revokeObjectURL(url);
    }
    window.exportCSV = exportCSV;
  </script>
</body>
</html>
